<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Браузер</title>
    <style>
        /* ОБЩИЕ ПЕРЕМЕННЫЕ И СТИЛИ */
        :root {
            --primary-color: #FF4D4D;
            --secondary-color: #CC3D3D;
            --bg-color: #18181A;
            --text-color: #FFFFFF;
            --search-bg: #2A2A2E;
            --panel-bg: #252529;
            --border-color: #3A3A3E;
            --slider-bg: #3A3A3E;
            --sidebar-bg: #252529;
            --sidebar-hover-bg: #3a3a3e;
            --shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        body[data-theme="light"] {
            --bg-color: #F0F2F5;
            --text-color: #1C1E21;
            --search-bg: #FFFFFF;
            --panel-bg: #FFFFFF;
            --border-color: #DADDE1;
            --slider-bg: #CED0D4;
            --sidebar-bg: #F0F2F5;
            --sidebar-hover-bg: #E4E6E9;
            --shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        body[data-theme="oled"] {
            --bg-color: #000000;
            --text-color: #E4E6EB;
            --search-bg: #1A1A1A;
            --panel-bg: #141414;
            --border-color: #2A2A2A;
            --slider-bg: #3A3A3E;
            --sidebar-bg: #000000;
            --sidebar-hover-bg: #1A1A1A;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        #main-page, #settings-page {
            width: 100%;
            height: 100vh;
            box-sizing: border-box;
        }

        /* СТИЛИ ГЛАВНОЙ СТРАНИЦЫ (ИЗ ФАЙЛА 1) */
        #main-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
            overflow: hidden;
            opacity: 0;
            animation: fadeIn 1.2s cubic-bezier(0.22, 0.61, 0.36, 1) forwards;
            transition: background-color 0.3s, color 0.3s;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .glow-background { position: absolute; width: 100%; height: 100%; top: 0; left: 0; z-index: 1; overflow: hidden; }
        .glow-point { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0; transform: translate(-50%, -50%); transition: opacity 3s ease-in-out, background 1.5s ease; will-change: opacity, background; }
        .settings-btn { position: absolute; top: 20px; right: 20px; background: none; border: none; color: var(--text-color); font-size: 24px; cursor: pointer; z-index: 20; opacity: 0; transform: translateY(-10px); transition: opacity 0.3s ease, transform 0.3s ease, color 0.3s; animation: fadeInElement 0.8s cubic-bezier(0.22, 0.61, 0.36, 1) 0.4s forwards; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; width: 30px; height: 30px; }
        .settings-btn:hover { opacity: 1 !important; }
        .settings-btn-dot { width: 4px; height: 4px; background-color: var(--text-color); border-radius: 50%; transition: background-color 0.3s; }
        .settings-menu { position: absolute; top: 60px; right: 20px; background: #2A2A2E; border-radius: 8px; padding: 10px 0; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5); z-index: 20; display: none; flex-direction: column; min-width: 180px; opacity: 0; transform: translateY(-10px); transition: opacity 0.3s ease, transform 0.3s ease, background-color 0.3s; }
        body[data-theme="light"] .settings-menu { background: #FFFFFF; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        body[data-theme="oled"] .settings-menu { background: #141414; }
        .settings-menu.show { display: flex; opacity: 1; transform: translateY(0); }
        .menu-item { padding: 10px 16px; text-align: left; color: var(--text-color); text-decoration: none; transition: background 0.2s, color 0.3s; cursor: pointer; font-size: 14px; background: none; border: none; width: 100%; }
        .menu-item:hover { background: #3A3A3E; }
        body[data-theme="light"] .menu-item:hover { background: #E4E6E9; }
        body[data-theme="oled"] .menu-item:hover { background: #1A1A1A; }
        .menu-divider { height: 1px; background-color: #3A3A3E; margin: 5px 0; transition: background-color 0.3s; }
        body[data-theme="light"] .menu-divider { background-color: #DADDE1; }
        body[data-theme="oled"] .menu-divider { background-color: #2A2A2A; }
        .logo { font-size: 42px; margin-bottom: 30px; font-weight: 500; color: var(--text-color); display: flex; align-items: center; gap: 8px; z-index: 2; opacity: 0; transform: translateY(20px); animation: fadeInUp 1s cubic-bezier(0.22, 0.61, 0.36, 1) 0.6s forwards; transition: color 0.5s ease; }
        .logo::before { content: "•"; color: var(--primary-color); font-size: 60px; line-height: 0; transition: color 0.5s ease; }
        .search-container { width: 100%; max-width: 600px; position: relative; z-index: 2; opacity: 0; transform: translateY(20px); animation: fadeInUp 1s cubic-bezier(0.22, 0.61, 0.36, 1) 0.8s forwards; }
        @keyframes fadeInElement { to { opacity: 0.7; transform: translateY(0); } }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        .search-wrapper { position: relative; border-radius: 12px; padding: 2px; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); background-size: 200% 200%; animation: gradientBG 5s ease infinite; box-shadow: 0 0 15px var(--primary-color); transition: all 0.5s ease; opacity: 0; transform: scale(0.95); animation: fadeInScale 1s cubic-bezier(0.22, 0.61, 0.36, 1) 0.8s forwards; }
        .search-wrapper::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; border-radius: 12px; padding: 2px; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); background-size: 200% 200%; z-index: -1; opacity: 0; transition: opacity 0.5s ease; }
        .search-wrapper.active-outline::after { opacity: 1; }
        @keyframes fadeInScale { to { opacity: 1; transform: scale(1); } }
        .search-input { width: 100%; padding: 16px 50px 16px 24px; font-size: 16px; border: none; border-radius: 10px; background-color: var(--search-bg); color: var(--text-color); outline: none; box-sizing: border-box; caret-color: var(--primary-color); opacity: 0; animation: fadeIn 0.6s ease-out 1.2s forwards; transition: caret-color 0.5s ease, background-color 0.3s, color 0.3s; }
        .search-input::placeholder { color: #AAAAAA; transition: opacity 0.3s ease, color 0.3s; }
        body[data-theme="light"] .search-input::placeholder { color: #65676B; }
        .search-input:focus::placeholder { opacity: 0.5; }
        .info-widget-container { width: 100%; max-width: 600px; display: flex; margin-top: 15px; z-index: 2; }
        .info-widget { font-size: 14px; color: #AAAAAA; opacity: 0; transform: translateY(10px); animation: fadeInUp 0.8s cubic-bezier(0.22, 0.61, 0.36, 1) 1.0s forwards; transition: opacity 0.5s, transform 0.5s, color 0.3s; }
        body[data-theme="light"] .info-widget { color: #65676B; }
        .info-widget.align-left { justify-self: flex-start; margin-right: auto; }
        .info-widget.align-center { margin-left: auto; margin-right: auto; }
        .info-widget.align-right { justify-self: flex-end; margin-left: auto; }
        .info-widget span { font-weight: 500; }
        .buttons-container { display: flex; gap: 10px; position: relative; min-height: 90px; z-index: 2; justify-content: center; flex-wrap: wrap; margin-top: 25px; width: 90%; max-width: 960px; }
        .site-btn-container, .add-btn-container { position: relative; width: 70px; height: 90px; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; margin-top: 10px; opacity: 0; transform: translateY(10px); animation-name: fadeInUp; animation-duration: 0.6s; animation-timing-function: cubic-bezier(0.22, 0.61, 0.36, 1); animation-fill-mode: forwards; }
        .add-btn { background: rgba(42, 42, 46, 0.7); border-radius: 8px; color: var(--text-color); box-shadow: var(--shadow); transition: transform 0.3s cubic-bezier(0.22, 0.61, 0.36, 1), background-color 0.3s, box-shadow 0.3s, color 0.3s; backdrop-filter: blur(5px); border: none; cursor: pointer; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; position: relative; flex-shrink: 0; }
        body[data-theme="light"] .add-btn { background: rgba(255, 255, 255, 0.7); border: 1px solid var(--border-color); }
        .add-btn::before { content: "+"; font-size: 36px; font-weight: 300; transition: transform 0.3s ease, color 0.3s ease; }
        .add-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3); color: var(--primary-color); }
        .add-btn:hover::before { transform: scale(1.2); color: var(--primary-color); }
        .site-btn { background: rgba(42, 42, 46, 0.7); padding: 12px; border-radius: 8px; box-shadow: var(--shadow); transition: transform 0.3s cubic-bezier(0.22, 0.61, 0.36, 1), background-color 0.3s; backdrop-filter: blur(5px); border: none; cursor: pointer; width: 60px; height: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        body[data-theme="light"] .site-btn { background: rgba(255, 255, 255, 0.7); border: 1px solid var(--border-color); }
        .site-btn:hover { transform: translateY(-2px); }
        .site-btn img { width: 32px; height: 32px; object-fit: contain; pointer-events: none; }
        .site-btn span { font-size: 12px; margin-top: 5px; color: var(--text-color); display: block; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; pointer-events: none; transition: color 0.3s; }
        .widget-settings-btn { position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); width: 40px; height: 20px; background: rgba(60, 60, 64, 0.9); border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.3s ease, background 0.3s ease; cursor: pointer; pointer-events: none; }
        .site-btn-container:hover .widget-settings-btn { opacity: 1; pointer-events: auto; }
        .widget-settings-btn:hover { background: rgba(70, 70, 74, 1); }
        .widget-settings-dot { width: 4px; height: 4px; background-color: var(--text-color); border-radius: 50%; margin: 0 1px; transition: all 0.3s ease; }
        .widget-settings-btn:hover .widget-settings-dot { background-color: var(--primary-color); }
        .fullscreen-menu { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); z-index: 100; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; }
        .fullscreen-menu.show { display: flex; opacity: 1; }
        .menu-content { background-color: var(--bg-color); border-radius: 12px; padding: 30px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); position: relative; transition: background-color 0.3s; }
        .close-menu { position: absolute; top: 15px; right: 15px; background: none; border: none; color: var(--text-color); font-size: 24px; cursor: pointer; transition: color 0.3s ease; }
        .close-menu:hover { color: var(--primary-color); }
        .menu-title { font-size: 24px; margin-bottom: 20px; color: var(--primary-color); transition: color 0.3s; }
        .bookmark-form { display: flex; flex-direction: column; gap: 20px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-group.hidden { display: none; }
        .form-label { font-size: 16px; color: var(--text-color); text-align: left; transition: color 0.3s; }
        .form-input { padding: 12px 16px; border-radius: 8px; border: 1px solid var(--border-color); background-color: #2A2A2E; color: var(--text-color); font-size: 16px; outline: none; transition: border-color 0.3s ease, background-color 0.3s, color 0.3s; box-sizing: border-box; width: 100%; }
        body[data-theme="light"] .form-input { background-color: #FFFFFF; }
        body[data-theme="oled"] .form-input { background-color: #1A1A1A; }
        .form-input:focus { border-color: var(--primary-color); }
        .image-options { display: flex; gap: 15px; margin-top: 10px; }
        .image-option { flex: 1; padding: 15px; border-radius: 8px; background-color: #2A2A2E; border: 1px solid var(--border-color); cursor: pointer; transition: all 0.3s ease; text-align: center; }
        body[data-theme="light"] .image-option { background-color: #FFFFFF; }
        body[data-theme="oled"] .image-option { background-color: #1A1A1A; }
        .image-option.selected { border-color: var(--primary-color); background-color: rgba(255, 77, 77, 0.1); }
        .image-option input[type="radio"] { display: none; }
        .submit-btn { padding: 12px 24px; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: transform 0.3s ease, background-image 0.5s; margin-top: 10px; }
        .submit-btn:hover { transform: translateY(-2px); }
        .widget-settings-menu { position: fixed; background: #2A2A2E; border-radius: 8px; padding: 10px 0; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5); z-index: 110; display: none; flex-direction: column; min-width: 180px; opacity: 0; transform: translate(-50%, -100%) scale(0.9); transform-origin: bottom center; transition: opacity 0.2s ease, transform 0.2s ease, background-color 0.3s; }
        body[data-theme="light"] .widget-settings-menu { background: #FFFFFF; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        body[data-theme="oled"] .widget-settings-menu { background: #141414; }
        .widget-settings-menu.show { display: flex; opacity: 1; transform: translate(-50%, -100%) scale(1); }
        .widget-menu-item { padding: 10px 16px; color: var(--text-color); text-decoration: none; transition: background 0.2s, color 0.3s; cursor: pointer; font-size: 14px; background: none; border: none; width: 100%; text-align: left; }
        .widget-menu-item:hover { background: #3A3A3E; }
        body[data-theme="light"] .widget-menu-item:hover { background: #E4E6E9; }
        body[data-theme="oled"] .widget-menu-item:hover { background: #1A1A1A; }
        .widget-menu-item.delete { color: #FF4D4D; }
        .widget-menu-divider { height: 1px; background-color: #3A3A3E; margin: 5px 0; transition: background-color 0.3s; }
        body[data-theme="light"] .widget-menu-divider { background-color: #DADDE1; }
        body[data-theme="oled"] .widget-menu-divider { background-color: #2A2A2A; }
        .about-popup { position: fixed; background: var(--search-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px 16px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5); z-index: 25; display: none; flex-direction: column; align-items: center; opacity: 0; transform: scale(0.95); transition: opacity 0.2s ease, transform 0.2s ease, background-color 0.3s, border-color 0.3s; pointer-events: none; }
        .about-popup.show { display: flex; opacity: 1; transform: scale(1); }
        .about-title { font-size: 16px; font-weight: 500; color: var(--text-color); transition: color 0.3s; }
        .about-version { font-size: 12px; color: #AAAAAA; margin-top: 2px; transition: color 0.3s; }
        body[data-theme="light"] .about-version { color: #65676B; }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        /* Стили для кнопки голосового ввода */
        .voice-search-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .voice-search-btn svg {
            width: 22px;
            height: 22px;
            fill: var(--text-color);
            opacity: 0.6;
            transition: opacity 0.2s, fill 0.2s;
        }

        .voice-search-btn:hover svg {
            opacity: 1;
        }

        .voice-search-btn.active svg {
            opacity: 1;
            fill: var(--primary-color);
        }

        /* Анимация пульсации во время записи */
        .voice-search-btn.active {
            --pulse-color: var(--primary-color);
            animation: pulse-dynamic 1.5s infinite;
        }
        @keyframes pulse-dynamic {
            0% { box-shadow: 0 0 0 0 color-mix(in srgb, var(--pulse-color) 70%, transparent); }
            70% { box-shadow: 0 0 0 10px color-mix(in srgb, var(--pulse-color) 0%, transparent); }
            100% { box-shadow: 0 0 0 0 color-mix(in srgb, var(--pulse-color) 0%, transparent); }
        }

        /* СТИЛИ СТРАНИЦЫ НАСТРОЕК (ИЗ ФАЙЛА 2) */
        #settings-page { display: none; flex-direction: column; }
        .settings-main-header { display: flex; align-items: center; justify-content: space-between; padding: 15px 25px; background-color: var(--panel-bg); border-bottom: 1px solid var(--border-color); flex-shrink: 0; transition: background-color 0.3s, border-color 0.3s; }
        .header-title { font-size: 24px; font-weight: 500; margin-left: 10px; flex-grow: 1;}
        .search-settings { width: 100%; max-width: 400px; }
        /* .search-wrapper is already defined */
        .search-settings input { width: 100%; padding: 10px 16px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--search-bg); color: var(--text-color); font-size: 15px; outline: none; box-sizing: border-box; caret-color: var(--primary-color); transition: border-color .3s, box-shadow .3s, background-color 0.3s, color 0.3s; }
        .search-settings input:focus { border-color: var(--primary-color); box-shadow: 0 0 8px -1px var(--primary-color); }
        .settings-container { display: flex; flex-grow: 1; overflow: hidden; }
        .settings-sidebar { width: 240px; flex-shrink: 0; background-color: var(--sidebar-bg); padding: 20px 0; overflow-y: auto; transition: background-color 0.3s; }
        .sidebar-menu { list-style: none; padding: 0; margin: 0; }
        .sidebar-link { position: relative; display: block; padding: 12px 25px; color: var(--text-color); text-decoration: none; font-size: 15px; cursor: pointer; transition: background-color 0.2s, color 0.3s; }
        .sidebar-link::before { content: ''; position: absolute; left: 0; top: 50%; width: 3px; height: 0; background-color: var(--primary-color); box-shadow: 0 0 15px 1px var(--primary-color); border-radius: 2px; opacity: 0; transition: height 0.3s ease, top 0.3s ease, opacity 0.3s ease, box-shadow 0.3s ease; }
        .sidebar-link:hover { background-color: var(--sidebar-hover-bg); }
        .sidebar-link.active { background-color: var(--sidebar-hover-bg); font-weight: 500; }
        .sidebar-link.active::before { top: 0; height: 100%; opacity: 1; }
        .settings-main-content { flex-grow: 1; padding: 30px 40px; overflow-y: auto; }
        .settings-section { display: none; max-width: 650px; animation: fadeInContent 0.4s ease; }
        .settings-section.active { display: block; }
        @keyframes fadeInContent { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .section-title { font-size: 22px; margin-bottom: 25px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); transition: border-color 0.3s; }
        .all-settings-subtitle { font-size: 18px; font-weight: 500; margin-top: 35px; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color); color: #ccc; transition: border-color 0.3s, color 0.3s; }
        body[data-theme="light"] .all-settings-subtitle { color: #65676B; }
        .all-settings-subtitle:first-of-type { margin-top: 0; }
        .hidden-by-search { display: none !important; }
        .setting-item, .form-group { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; transition: border-color 0.3s; }
        #settings-page .form-group { flex-direction: column; align-items: flex-start; }
        .setting-item:last-child, #settings-page .form-group:last-child { border-bottom: none; }
        .setting-label, #settings-page .form-label { font-size: 16px; }
        .setting-description { font-size: 13px; color: #aaa; margin-top: 4px; transition: color 0.3s; }
        body[data-theme="light"] .setting-description { color: #65676B; }
        .setting-control { display: flex; align-items: center; margin-left: auto; padding-left: 15px; }
        .setting-control-group { display: flex; align-items: center; gap: 15px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--slider-bg); transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        .color-preview { width: 24px; height: 24px; border-radius: 50%; background-color: var(--primary-color); border: 2px solid var(--text-color); cursor: pointer; transition: transform 0.2s, background-color 0.4s, border-color 0.3s; flex-shrink: 0; }
        .color-preview:hover { transform: scale(1.1); }
        #settings-page .form-input { width: 100%; max-width: 350px; padding: 10px 12px; border-radius: 6px; border: 1px solid var(--border-color); background-color: var(--bg-color); color: var(--text-color); font-size: 15px; transition: border-color .3s, background-color 0.3s, color 0.3s; }
        .action-button { padding: 10px 20px; background: var(--search-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 6px; font-size: 15px; cursor: pointer; transition: background-color 0.2s, color 0.2s, border-color 0.2s; }
        .action-button:hover { background-color: var(--sidebar-hover-bg); }
        .action-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .control-icon-btn { background: none; border: none; color: var(--text-color); cursor: pointer; padding: 5px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.2s, color 0.2s; flex-shrink: 0; }
        .control-icon-btn:hover { background-color: var(--sidebar-hover-bg); }
        .control-icon-btn svg { width: 20px; height: 20px; fill: currentColor; }
        .form-select { display: none; }
        .custom-select-wrapper { position: relative; user-select: none; flex-shrink: 0; }
        .setting-control-group .custom-select-wrapper { min-width: 120px; }
        .custom-select-trigger { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border-radius: 6px; border: 1px solid var(--border-color); background-color: var(--bg-color); color: var(--text-color); font-size: 15px; cursor: pointer; transition: border-color 0.2s, background-color 0.3s; white-space: nowrap; }
        .custom-select-trigger.small { padding: 6px 10px; font-size: 14px; background-color: var(--search-bg); }
        .custom-select-trigger::after { content: ''; width: 12px; height: 12px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23FFFFFF' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: center; background-size: contain; transition: transform 0.2s; margin-left: 8px; filter: invert(var(--icon-invert, 0)); }
        body[data-theme="light"] .custom-select-trigger::after { --icon-invert: 1; }
        .custom-select-wrapper.open .custom-select-trigger { border-color: var(--primary-color); }
        .custom-select-wrapper.open .custom-select-trigger::after { transform: rotate(180deg); }
        .custom-select-options { position: absolute; top: calc(100% + 5px); right: 0; min-width: 120px; width: 100%; background-color: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 6px; z-index: 10; display: none; overflow: hidden; box-shadow: var(--shadow); transition: background-color 0.3s, border-color 0.3s; }
        .custom-select-wrapper.open .custom-select-options { display: block; }
        .custom-select-option { padding: 10px 12px; cursor: pointer; transition: background-color 0.2s; text-align: left; }
        .custom-select-option:hover { background-color: var(--sidebar-hover-bg); }
        .custom-select-option.selected { background-color: var(--primary-color); color: white; font-weight: 500; }
        .custom-select-option .sub-menu-arrow { float: right; }
        .popup-panel { position: absolute; background-color: var(--panel-bg); padding: 8px; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: var(--shadow); z-index: 100; display: none; flex-direction: column; gap: 2px; min-width: 180px; animation: fadeInContent 0.2s ease; transition: background-color 0.3s, border-color 0.3s; }
        .popup-panel.show { display: flex; }
        .popup-menu-item { padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: background-color 0.2s, color 0.3s; font-size: 15px; display: flex; justify-content: space-between; align-items: center; }
        .popup-menu-item:hover { background-color: var(--sidebar-hover-bg); }
        .popup-menu-item.selected { background-color: var(--primary-color) !important; color: white; }
        .popup-menu-divider { height: 1px; background-color: var(--border-color); margin: 6px 0; transition: border-color 0.3s; }
        .currency-picker-panel { flex-direction: row; padding: 15px; gap: 15px; min-width: 320px; box-sizing: border-box; }
        .currency-picker-panel .column { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .currency-picker-panel label { font-size: 14px; text-align: center; color: #aaa; transition: color 0.3s;}
        .currency-picker-panel .custom-select-wrapper { width: 100%; }
        .color-picker-panel { position: absolute; background-color: var(--panel-bg); padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: var(--shadow); z-index: 110; display: none; flex-direction: column; gap: 10px; width: 220px; transition: background-color 0.3s, border-color 0.3s; }
        .color-picker-panel.show { display: flex; animation: fadeInContent 0.2s ease; }
        .color-picker-sv-area, .color-picker-hue-slider { position: relative; width: 100%; border-radius: 4px; overflow: hidden; } .color-picker-sv-area { height: 150px; } .color-picker-hue-slider { height: 12px; border-radius: 6px; } .color-picker-sv-area canvas, .color-picker-hue-slider canvas { width: 100%; height: 100%; cursor: pointer; } .color-picker-handle, .color-picker-hue-handle { position: absolute; border: 2px solid white; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.5); pointer-events: none; transform: translate(-50%, -50%); } .color-picker-handle { width: 12px; height: 12px; } .color-picker-hue-handle { width: 6px; height: 16px; top: 50%; border-radius: 2px; }
        .color-picker-hex-input { width: 100%; padding: 8px; box-sizing: border-box; border-radius: 6px; border: 1px solid var(--border-color); background-color: var(--bg-color); color: var(--text-color); font-size: 14px; text-align: center; font-family: monospace; outline: none; transition: border-color 0.3s, background-color 0.3s, color 0.3s; }
        
        #closeSettingsBtn { background: none; border: none; color: var(--text-color); cursor: pointer; padding: 5px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.2s, color 0.2s; font-size: 24px; font-weight: bold; }
        #closeSettingsBtn:hover { background-color: var(--sidebar-hover-bg); }

        @media (max-width: 768px) {
            .settings-container { flex-direction: column; } .settings-sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--border-color); }
            .settings-main-content { padding: 20px; } .settings-main-header { flex-direction: column; gap: 15px; padding: 15px; }
            .header-title { text-align: center; }
        }
        @media (max-width: 650px) {
            .search-container { width: 90%; }
            .logo { font-size: 36px; }
            .menu-content { padding: 20px; width: 95%; }
        }
    </style>
</head>
<body data-theme="dark">
    
    <!-- ГЛАВНАЯ СТРАНИЦА -->
    <div id="main-page">
        <button class="settings-btn" type="button" id="settingsBtn"><div class="settings-btn-dot"></div><div class="settings-btn-dot"></div><div class="settings-btn-dot"></div></button>
        <div class="settings-menu" id="settingsMenu"><button class="menu-item" id="openSettings">Настройки</button><button class="menu-item" id="aboutBtn">О браузере</button><div class="menu-divider"></div><button class="menu-item">Кнопка 1</button><button class="menu-item">Кнопка 2</button><button class="menu-item">Кнопка 3</button></div>
        <div class="glow-background" id="glowBackground"></div>
        <div class="logo">Браузер</div>
        <div class="search-container">
            <div class="search-wrapper" id="searchWrapper">
                <input type="text" class="search-input" placeholder="Найти в интернете или ввести адрес" id="searchInput">
                <button type="button" class="voice-search-btn" id="voiceSearchBtn" title="Голосовой поиск" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/></svg>
                </button>
            </div>
        </div>
        
        <div class="info-widget-container" id="currency-widget-container" style="display: none;">
            <div class="info-widget" id="currency-widget">Загрузка курса...</div>
        </div>
        
        <div class="buttons-container" id="buttonsContainer">
            <div class="add-btn-container">
                <button class="add-btn" id="addBtn"></button>
            </div>
        </div>
        <div class="fullscreen-menu" id="fullscreenMenu"><div class="menu-content"><button class="close-menu" id="closeMenu">×</button><h2 class="menu-title" id="menuTitle">Добавить закладку</h2><form class="bookmark-form" id="bookmarkForm"><input type="hidden" id="bookmarkId"><div class="form-group"><label for="bookmarkName" class="form-label">Название (необязательно)</label><input type="text" id="bookmarkName" class="form-input" placeholder="Например, YouTube"></div><div class="form-group"><label class="form-label">Изображение</label><div class="image-options"><label class="image-option selected" id="autoImageOption"><input type="radio" name="imageOption" value="auto" checked>Авто</label><label class="image-option" id="customImageOption"><input type="radio" name="imageOption" value="custom">Свое</label></div></div><div class="form-group" id="urlInputContainer"><label for="bookmarkUrl" class="form-label">URL</label><input type="url" id="bookmarkUrl" class="form-input" placeholder="https://example.com" required></div><div class="form-group hidden" id="fileInputContainer"><label for="bookmarkImage" class="form-label">Выберите файл</label><input type="file" id="bookmarkImage" class="form-input" accept="image/*"></div><button type="submit" class="submit-btn" id="submitBtn">Добавить</button></form></div></div>
        <div class="widget-settings-menu" id="widgetSettingsMenu"><button class="widget-menu-item" data-action="edit">Редактировать</button><div class="widget-menu-divider"></div><button class="widget-menu-item delete" data-action="delete">Удалить</button></div>
        <div class="about-popup" id="aboutPopup"><div class="about-title">Alpla</div><div class="about-version">v.Alpha.0.0.1</div></div>
    </div>

    <!-- СТРАНИЦА НАСТРОЕК -->
    <div id="settings-page">
         <header class="settings-main-header">
            <button id="closeSettingsBtn" title="Назад">&larr;</button>
            <div class="header-title">Настройки</div>
            <div class="search-settings"><div class="search-wrapper"><input type="text" placeholder="Поиск настроек...(нереализовано)" id="settingsSearch"></div></div>
        </header>
        <div class="settings-container">
            <nav class="settings-sidebar">
                <ul class="sidebar-menu">
                    <li><a class="sidebar-link active" data-target="all-settings">Все настройки</a></li>
                    <li><a class="sidebar-link" data-target="appearance-settings">Внешний вид</a></li>
                    <li><a class="sidebar-link" data-target="elements-settings">Элементы</a></li>
                    <li><a class="sidebar-link" data-target="data-settings">Данные</a></li>
                </ul>
            </nav>
            <main class="settings-main-content">
                <section class="settings-section active" id="all-settings"><h2 class="section-title">Все настройки</h2></section>
                
                <section class="settings-section" id="appearance-settings">
                    <h2 class="section-title">Внешний вид</h2>
                    <div class="setting-item">
                        <div><div class="setting-label">Тема оформления</div><div class="setting-description">Выберите светлую, темную или свою тему</div></div>
                        <div class="setting-control">
                            <div class="color-preview" data-control="theme-picker"></div>
                            <div class="popup-panel theme-picker-panel">
                                <div class="popup-menu-item" data-theme-value="dark">Темная</div>
                                <div class="popup-menu-item" data-theme-value="light">Светлая</div>
                                <div class="popup-menu-item" data-theme-value="oled">OLED (черная)</div>
                                <div class="popup-menu-divider"></div>
                                <div class="popup-menu-item" data-theme-value="custom">Своя <span class="sub-menu-arrow">›</span></div>
                            </div>
                            <div class="popup-panel custom-theme-picker-panel">
                                <div class="popup-menu-item" data-control="color-picker" data-color-key="background">Фон</div>
                                <div class="popup-menu-item" data-control="color-picker" data-color-key="text">Текст</div>
                            </div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div><div class="setting-label">Анимации</div><div class="setting-description">Включает плавные переходы и эффекты (нереализовано)</div></div>
                        <div class="setting-control"><label class="switch"><input type="checkbox" data-group="settings" data-key="animations"><span class="slider"></span></label></div>
                    </div>
                    <div class="setting-item">
                        <div><div class="setting-label">Акцентный цвет</div><div class="setting-description">Основной акцентный цвет интерфейса</div></div>
                        <div class="setting-control">
                            <div class="color-preview" data-control="color-picker" data-color-key="accent"></div>
                        </div>
                    </div>
                </section>

                <section class="settings-section" id="elements-settings">
                    <h2 class="section-title">Элементы на главной странице</h2>
                    <div class="setting-item">
                         <div><div class="setting-label">Показывать курсы валют</div><div class="setting-description">Виджет с актуальными курсами валют</div></div>
                         <div class="setting-control">
                            <div class="setting-control-group">
                                <button type="button" class="control-icon-btn" data-control="currency-picker" title="Настроить валюты">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.44 12.99l.86-1.58a1 1 0 00-.2-1.34l-1.6-1.6a1 1 0 00-1.34-.2l-1.58.86a8.05 8.05 0 00-2.58-.93V4.5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2.7a8.05 8.05 0 00-2.58.93l-1.58-.86a1 1 0 00-1.34.2l-1.6 1.6a1 1 0 00-.2 1.34l.86 1.58a8.05 8.05 0 000 3.02l-.86 1.58a1 1 0 00.2 1.34l1.6 1.6a1 1 0 001.34.2l1.58-.86a8.05 8.05 0 002.58.93V20.5a1 1 0 001 1h2a1 1 0 001-1v-2.7a8.05 8.05 0 002.58-.93l1.58.86a1 1 0 001.34-.2l1.6-1.6a1 1 0 00.2-1.34l-.86-1.58a8.05 8.05 0 000-3.02zM12 15.5a3.5 3.5 0 110-7 3.5 3.5 0 010 7z"/></svg>
                                </button>
                                <select class="form-select small" data-group="settings" data-key="currencyPosition">
                                    <option value="right">Справа</option><option value="center">В центре</option><option value="left">Слева</option>
                                </select>
                                <label class="switch"><input type="checkbox" data-group="settings" data-key="showCurrency"><span class="slider"></span></label>
                            </div>
                            <div class="popup-panel currency-picker-panel">
                                <div class="column"><label>Базовая валюта</label><select class="form-select" data-group="settings" data-key="currencyBase"></select></div>
                                <div class="column"><label>Целевая валюта</label><select class="form-select" data-group="settings" data-key="currencyTarget"></select></div>
                            </div>
                         </div>
                    </div>
                    <div class="setting-item">
                        <div><div class="setting-label">Показывать погоду</div><div class="setting-description">Виджет с прогнозом погоды для вашего города (нереализовано)</div></div>
                        <div class="setting-control"><label class="switch"><input type="checkbox" data-group="settings" data-key="showWeather"><span class="slider"></span></label></div>
                    </div>
                    <div class="setting-item">
                        <div><div class="setting-label">Показывать пробки</div><div class="setting-description">Информация о загруженности дорог (нереализовано)</div></div>
                        <div class="setting-control"><label class="switch"><input type="checkbox" data-group="settings" data-key="showTraffic"><span class="slider"></span></label></div>
                    </div>
                </section>
                
                <section class="settings-section" id="data-settings">
                    <h2 class="section-title">Персональные данные</h2>
                     <div class="form-group">
                        <div class="setting-label">Автоопределение данных</div>
                        <div class="setting-description">Автоматически установить город и язык (нереализовано).</div>
                        <div style="margin-top: 15px;"><button class="action-button" id="autoDetectBtn">Определить автоматически</button></div>
                    </div>
                    <div class="form-group">
                        <label class="setting-label">Город</label>
                        <input type="text" class="form-input" placeholder="Например, Москва" data-group="data" data-key="city">
                    </div>
                    <div class="setting-item">
                        <div><div class="setting-label">Язык и формат времени</div><div class="setting-description">(нереализовано)</div></div>
                        <div class="setting-control setting-control-group">
                            <select class="form-select small" data-group="data" data-key="language">
                                <option value="ru-RU">Русский</option><option value="en-US">English (USA)</option>
                                <option value="en-GB">English (UK)</option><option value="de-DE">Deutsch</option>
                            </select>
                            <select class="form-select small" data-group="data" data-key="timeFormat">
                                <option value="24h">24-часовой</option><option value="12h">12-часовой</option>
                            </select>
                        </div>
                    </div>
                </section>
                
                <div class="color-picker-panel" id="colorPicker">
                    <div class="color-picker-sv-area"><canvas></canvas><div class="color-picker-handle"></div></div>
                    <div class="color-picker-hue-slider"><canvas></canvas><div class="color-picker-hue-handle"></div></div>
                    <input type="text" class="color-picker-hex-input">
                </div>
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- ОБЩИЕ ПЕРЕМЕННЫЕ И СОСТОЯНИЕ ---
            const settingsChannel = new BroadcastChannel('homepage_settings');
            let activeWidgetId = null;
            let isDraggingSV = false;
            let isDraggingHue = false;
            let activeColorKey = 'accent';

            const defaultSettings = { theme: 'dark', animations: true, showCurrency: false, currencyPosition: 'center', currencyBase: 'usd', currencyTarget: 'rub', showWeather: true, showTraffic: false };
            const defaultData = { city: 'Москва', language: 'ru-RU', timeFormat: '24h' };
            const defaultColors = { accent: { r: 255, g: 77, b: 77 }, background: { r: 24, g: 24, b: 26 }, text: { r: 255, g: 255, b: 255 } };
            const availableCurrencies = { "rub": "Российский рубль", "usd": "Доллар США", "eur": "Евро", "gbp": "Британский фунт", "jpy": "Японская иена", "cny": "Китайский юань" };
            
            const appState = {
                settings: { ...defaultSettings },
                data: { ...defaultData },
                colors: { ...defaultColors }
            };

            // --- УПРАВЛЕНИЕ СОСТОЯНИЕМ (ЗАГРУЗКА/СОХРАНЕНИЕ) ---
            function loadState() {
                const loadedSettings = JSON.parse(localStorage.getItem('homepageSettings'));
                if (loadedSettings) appState.settings = { ...appState.settings, ...loadedSettings };
                const loadedData = JSON.parse(localStorage.getItem('homepageData'));
                if (loadedData) appState.data = { ...appState.data, ...loadedData };
                const loadedColors = JSON.parse(localStorage.getItem('homepageColors'));
                if (loadedColors) appState.colors = { ...appState.colors, ...loadedColors };
            }

            function saveState(group) {
                localStorage.setItem(`homepage${group.charAt(0).toUpperCase() + group.slice(1)}`, JSON.stringify(appState[group]));
                settingsChannel.postMessage({ type: `${group}-update`, payload: appState[group] });
            }

            function saveColorsState() {
                localStorage.setItem('homepageColors', JSON.stringify(appState.colors));
                settingsChannel.postMessage({ type: 'colors-update', payload: appState.colors });
            }

            // --- ФУНКЦИИ ПРИМЕНЕНИЯ НАСТРОЕК (UI) ---
            function applyTheme() {
                const theme = appState.settings.theme;
                document.body.dataset.theme = theme;

                document.documentElement.style.removeProperty('--bg-color');
                document.documentElement.style.removeProperty('--text-color');

                if (theme === 'custom') {
                    const { background, text } = appState.colors;
                    if (background) document.documentElement.style.setProperty('--bg-color', `rgb(${background.r}, ${background.g}, ${background.b})`);
                    if (text) document.documentElement.style.setProperty('--text-color', `rgb(${text.r}, ${text.g}, ${text.b})`);
                }
                
                const { accent } = appState.colors;
                if (accent) {
                    const hexColor = `#${accent.r.toString(16).padStart(2, '0')}${accent.g.toString(16).padStart(2, '0')}${accent.b.toString(16).padStart(2, '0')}`;
                    const darkerColor = `#${Math.max(0, accent.r - 50).toString(16).padStart(2, '0')}${Math.max(0, accent.g - 50).toString(16).padStart(2, '0')}${Math.max(0, accent.b - 50).toString(16).padStart(2, '0')}`;
                    document.documentElement.style.setProperty('--primary-color', hexColor);
                    document.documentElement.style.setProperty('--secondary-color', darkerColor);
                    if (document.getElementById('glowBackground')) {
                        createGlowPoints('glowBackground', 3, [hexColor, darkerColor]);
                    }
                }
            }

            function updateAllUIFromState() {
                document.querySelectorAll('input[type="checkbox"][data-group][data-key]').forEach(input => {
                    const { group, key } = input.dataset;
                    if (appState[group] && typeof appState[group][key] !== 'undefined') {
                        input.checked = appState[group][key];
                    }
                });
                
                document.querySelectorAll('select.form-select').forEach(select => {
                    const { group, key } = select.dataset;
                    if (appState[group] && typeof appState[group][key] !== 'undefined') {
                        select.value = appState[group][key];
                        updateCustomSelectDisplay(select);
                    }
                });

                const accentColorRGB = `rgb(${appState.colors.accent.r}, ${appState.colors.accent.g}, ${appState.colors.accent.b})`;
                document.querySelectorAll('[data-color-key="accent"], [data-control="theme-picker"]').forEach(preview => {
                    preview.style.backgroundColor = accentColorRGB;
                });
                
                const themePreview = document.querySelector('[data-control="theme-picker"]');
                const themeTextColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
                if(themePreview) themePreview.style.borderColor = themeTextColor;
                
                document.querySelectorAll('.theme-picker-panel .popup-menu-item').forEach(item => {
                    item.classList.toggle('selected', item.dataset.themeValue === appState.settings.theme);
                });

                const currencyContainer = document.getElementById('currency-widget-container');
                if (currencyContainer) {
                    if (appState.settings.showCurrency) {
                        fetchCurrencyRate(appState.settings.currencyPosition, appState.settings.currencyBase, appState.settings.currencyTarget);
                    } else {
                        currencyContainer.style.display = 'none';
                    }
                }
            }

            // --- ФУНКЦИИ ГЛАВНОЙ СТРАНИЦЫ ---
            function performSearch(query) { if (!query.trim()) return; const urlPattern = /^(https?:\/\/)?([\w-]+\.)+[\w-]+(\/[\w- .\/?%&=]*)?$/i; const isUrl = urlPattern.test(query); if (isUrl) { let url = query; if (!/^https?:\/\//i.test(query)) url = 'https://' + query; window.location.href = url; } else { window.location.href = `https://www.google.com/search?q=${encodeURIComponent(query)}`; } }
            function createGlowPoints(containerId, count = 3, colors = []) { const container = document.getElementById(containerId); if (!container) return; container.innerHTML = ''; for (let i = 0; i < count; i++) { const point = document.createElement('div'); point.className = 'glow-point'; point.style.width = `${100 + Math.random() * 200}px`; point.style.height = point.style.width; point.style.background = colors[i % colors.length]; point.style.left = `${Math.random() * 100}%`; point.style.top = `${Math.random() * 100}%`; container.appendChild(point); setTimeout(() => { point.style.opacity = '0.3'; setInterval(() => { point.style.transition = 'left 15s linear, top 15s linear'; point.style.left = `${Math.random() * 100}%`; point.style.top = `${Math.random() * 100}%`; }, 15000); }, 500); } }
            function getFaviconUrl(url) { try { const domain = new URL(url.startsWith('http') ? url : `https://${url}`).hostname; return `https://www.google.com/s2/favicons?domain=${domain}&sz=64`; } catch { return 'https://www.google.com/s2/favicons?domain=google.com&sz=64'; } }
            function getBookmarks() { return JSON.parse(localStorage.getItem('homepageBookmarks')) || []; }
            function saveBookmarks(bookmarks) { localStorage.setItem('homepageBookmarks', JSON.stringify(bookmarks)); }
            function createBookmarkElement(bookmark) { const container = document.createElement('div'); container.className = 'site-btn-container'; container.dataset.id = bookmark.id; const url = bookmark.url.startsWith('http') ? bookmark.url : `https://${bookmark.url}`; const fragment = document.createDocumentFragment(); const siteBtn = document.createElement('button'); siteBtn.className = 'site-btn'; siteBtn.dataset.url = url; siteBtn.innerHTML = `<img src="${bookmark.image}" alt="${bookmark.name} logo"><span>${bookmark.name}</span>`; const settingsBtn = document.createElement('div'); settingsBtn.className = 'widget-settings-btn'; settingsBtn.innerHTML = `<div class="widget-settings-dot"></div><div class="widget-settings-dot"></div><div class="widget-settings-dot"></div>`; fragment.appendChild(siteBtn); fragment.appendChild(settingsBtn); container.appendChild(fragment); return container; }
            function renderBookmarks() { const bookmarks = getBookmarks(); const container = document.getElementById('buttonsContainer'); if (!container) return; const addBtnContainer = container.querySelector('.add-btn-container'); container.querySelectorAll('.site-btn-container').forEach(el => el.remove()); bookmarks.forEach((bookmark, index) => { const bookmarkEl = createBookmarkElement(bookmark); bookmarkEl.style.animationDelay = `${0.8 + index * 0.1}s`; container.insertBefore(bookmarkEl, addBtnContainer); }); addBtnContainer.style.animationDelay = `${0.8 + bookmarks.length * 0.1}s`; }
            const readFileAsBase64 = (file) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = reject; reader.readAsDataURL(file); });
            async function fetchCurrencyRate(position, base = 'usd', target = 'rub') { const container = document.getElementById('currency-widget-container'); const widget = document.getElementById('currency-widget'); if (!container || !widget) return; widget.className = 'info-widget'; widget.classList.add(`align-${position}`); container.style.display = 'flex'; widget.textContent = 'Загрузка курса...'; try { const response = await fetch(`https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/${base}.json`); if (!response.ok) throw new Error('Сетевой ответ был не в порядке'); const data = await response.json(); const rate = data[base][target]; if (rate) { widget.innerHTML = `${base.toUpperCase()} 1 ≈ <span>${rate.toFixed(2)}</span> ${target.toUpperCase()}`; } else { widget.textContent = 'Не удалось получить курс'; } } catch (error) { console.error('Ошибка при загрузке курса валют:', error); widget.textContent = 'Ошибка загрузки курса'; } }

            // --- ФУНКЦИИ СТРАНИЦЫ НАСТРОЕК ---
            function closeAllPopups(exceptions = []) { document.querySelectorAll('.popup-panel.show, .color-picker-panel.show').forEach(p => { if (!exceptions.some(ex => ex === p || ex.contains(p))) { p.classList.remove('show'); } }); }
            function togglePopup(anchor, panel) {
                document.querySelectorAll('.custom-select-wrapper.open').forEach(w => w.classList.remove('open'));
                const isAlreadyOpen = panel.classList.contains('show');
                const parentPopup = anchor.closest('.popup-panel');
                closeAllPopups(parentPopup ? [parentPopup, panel] : [panel]);
                if (!isAlreadyOpen) {
                    panel.classList.add('show');
                    const rect = anchor.getBoundingClientRect();
                    panel.style.top = `${rect.bottom + 8}px`;
                    panel.style.left = `${rect.left}px`;
                    panel.style.right = 'auto';
                    if (rect.left + panel.offsetWidth > window.innerWidth - 20) {
                        panel.style.left = 'auto';
                        panel.style.right = '20px';
                    }
                }
            }
            function initializeCurrencyPicker() { document.querySelectorAll('.currency-picker-panel').forEach(panel => { const baseSelect = panel.querySelector('[data-key="currencyBase"]'); const targetSelect = panel.querySelector('[data-key="currencyTarget"]'); if (!baseSelect || !targetSelect) return; baseSelect.innerHTML = ''; targetSelect.innerHTML = ''; for (const [code, name] of Object.entries(availableCurrencies)) { baseSelect.add(new Option(name, code)); targetSelect.add(new Option(name, code)); } }); }
            function populateAllSettingsTab() { const allSettingsContainer = document.querySelector('#all-settings'); if (!allSettingsContainer) return; allSettingsContainer.innerHTML = '<h2 class="section-title">Все настройки</h2>'; document.querySelectorAll('.settings-section:not(#all-settings)').forEach(section => { const subTitle = document.createElement('h3'); subTitle.className = 'all-settings-subtitle'; subTitle.textContent = section.querySelector('.section-title').textContent; allSettingsContainer.appendChild(subTitle); section.querySelectorAll('.setting-item, #settings-page .form-group').forEach(item => { const clone = item.cloneNode(true); clone.querySelectorAll('[id]').forEach(el => el.removeAttribute('id')); allSettingsContainer.appendChild(clone); }); }); initializeCustomSelects(allSettingsContainer); }
            function updateCustomSelectDisplay(originalSelect) { const selectedOption = originalSelect.querySelector(`option[value="${originalSelect.value}"]`); if (!selectedOption) return; const key = originalSelect.dataset.key; document.querySelectorAll(`select[data-key="${key}"]`).forEach(selectEl => { const customWrapper = selectEl.closest('.setting-item, .form-group, .currency-picker-panel .column')?.querySelector('.custom-select-wrapper'); if (customWrapper) { const triggerSpan = customWrapper.querySelector('.custom-select-trigger span'); if (triggerSpan) triggerSpan.textContent = selectedOption.textContent; customWrapper.querySelectorAll('.custom-select-option').forEach(opt => { opt.classList.toggle('selected', opt.dataset.value === originalSelect.value); }); } }); }
            function initializeCustomSelects(container) { if (!container) return; container.querySelectorAll('.form-select').forEach(originalSelect => { if (originalSelect.nextElementSibling?.classList.contains('custom-select-wrapper')) { originalSelect.nextElementSibling.remove(); } const wrapper = document.createElement('div'); wrapper.className = 'custom-select-wrapper'; const trigger = document.createElement('div'); trigger.className = 'custom-select-trigger'; if (originalSelect.matches('[class*="small"]')) trigger.classList.add('small'); trigger.innerHTML = `<span>${originalSelect.options[originalSelect.selectedIndex]?.textContent || ''}</span>`; const options = document.createElement('div'); options.className = 'custom-select-options'; Array.from(originalSelect.options).forEach(optionEl => { const optionDiv = document.createElement('div'); optionDiv.className = 'custom-select-option'; optionDiv.textContent = optionEl.textContent; optionDiv.dataset.value = optionEl.value; optionDiv.addEventListener('click', () => { originalSelect.value = optionDiv.dataset.value; originalSelect.dispatchEvent(new Event('change', { bubbles: true })); wrapper.classList.remove('open'); }); options.appendChild(optionDiv); }); trigger.addEventListener('click', (e) => { e.stopPropagation(); const isCurrentlyOpen = wrapper.classList.contains('open'); document.querySelectorAll('.custom-select-wrapper.open').forEach(w => { w.classList.remove('open'); }); if (!isCurrentlyOpen) { wrapper.classList.add('open'); } }); wrapper.appendChild(trigger); wrapper.appendChild(options); originalSelect.style.display = 'none'; originalSelect.after(wrapper); }); }

            // --- COLOR PICKER ---
            const colorPicker = document.getElementById('colorPicker'); const svCanvas = colorPicker.querySelector('.color-picker-sv-area canvas'); const hueCanvas = colorPicker.querySelector('.color-picker-hue-slider canvas'); const svHandle = colorPicker.querySelector('.color-picker-handle'); const hueHandle = colorPicker.querySelector('.color-picker-hue-handle'); const hexInput = colorPicker.querySelector('.color-picker-hex-input'); const svCtx = svCanvas.getContext('2d'); const hueCtx = hueCanvas.getContext('2d'); let hsv = {};
            function updatePickerUI() { const rgb = hsvToRgb(hsv.h, hsv.s, hsv.v); svHandle.style.left = `${hsv.s * 100}%`; svHandle.style.top = `${(1 - hsv.v) * 100}%`; hueHandle.style.left = `${hsv.h * 100}%`; svHandle.style.backgroundColor = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`; hexInput.value = rgbToHex(rgb); drawSvCanvas(); appState.colors[activeColorKey] = rgb; applyTheme(); updateAllUIFromState(); }
            function saveAndApplyPickedColor() { saveColorsState(); if (appState.settings.theme !== 'custom' && activeColorKey !== 'accent') { appState.settings.theme = 'custom'; saveState('settings'); applyTheme(); updateAllUIFromState(); } }
            function hsvToRgb(h, s, v) { let r, g, b, i, f, p, q, t; i = Math.floor(h * 6); f = h * 6 - i; p = v * (1 - s); q = v * (1 - f * s); t = v * (1 - (1 - f) * s); switch (i % 6) { case 0: r = v; g = t; b = p; break; case 1: r = q; g = v; b = p; break; case 2: r = p; g = v; b = t; break; case 3: r = p; g = q; b = v; break; case 4: r = t; g = p; b = v; break; case 5: r = v; g = p; b = q; break; } return { r: Math.round(r * 255), g: Math.round(g * 255), b: Math.round(b * 255) }; } 
            function rgbToHsv(r, g, b) { r /= 255; g /= 255; b /= 255; let max = Math.max(r, g, b), min = Math.min(r, g, b); let h, s, v = max; let d = max - min; s = max == 0 ? 0 : d / max; if (max == min) { h = 0; } else { switch (max) { case r: h = (g - b) / d + (g < b ? 6 : 0); break; case g: h = (b - r) / d + 2; break; case b: h = (r - g) / d + 4; break; } h /= 6; } return { h, s, v }; } 
            function rgbToHex({ r, g, b }) { return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase(); } 
            function hexToRgb(hex) { const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null; } 
            function drawSvCanvas() { const width = svCanvas.clientWidth; const height = svCanvas.clientHeight; if (svCanvas.width !== width) svCanvas.width = width; if (svCanvas.height !== height) svCanvas.height = height; if (width === 0 || height === 0) return; svCtx.clearRect(0, 0, width, height); const rgb = hsvToRgb(hsv.h, 1, 1); svCtx.fillStyle = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`; svCtx.fillRect(0, 0, width, height); const whiteGrad = svCtx.createLinearGradient(0, 0, width, 0); whiteGrad.addColorStop(0, 'rgba(255,255,255,1)'); whiteGrad.addColorStop(1, 'rgba(255,255,255,0)'); svCtx.fillStyle = whiteGrad; svCtx.fillRect(0, 0, width, height); const blackGrad = svCtx.createLinearGradient(0, 0, 0, height); blackGrad.addColorStop(0, 'rgba(0,0,0,0)'); blackGrad.addColorStop(1, 'rgba(0,0,0,1)'); svCtx.fillStyle = blackGrad; svCtx.fillRect(0, 0, width, height); } 
            function drawHueCanvas() { const width = hueCanvas.clientWidth; const height = hueCanvas.clientHeight; if (hueCanvas.width !== width) hueCanvas.width = width; if (hueCanvas.height !== height) hueCanvas.height = height; if (width === 0 || height === 0) return; const grad = hueCtx.createLinearGradient(0, 0, width, 0); for (let i = 0; i <= 1; i += 1 / 6) { const rgb = hsvToRgb(i, 1, 1); grad.addColorStop(i, `rgb(${rgb.r},${rgb.g},${rgb.b})`); } hueCtx.fillStyle = grad; hueCtx.fillRect(0, 0, width, height); } 
            function handleSvChange(e) { const rect = svCanvas.getBoundingClientRect(); const x = Math.max(0, Math.min(e.clientX - rect.left, rect.width)); const y = Math.max(0, Math.min(e.clientY - rect.top, rect.height)); hsv.s = x / rect.width; hsv.v = 1 - (y / rect.height); updatePickerUI(); } 
            function handleHueChange(e) { const rect = hueCanvas.getBoundingClientRect(); const x = Math.max(0, Math.min(e.clientX - rect.left, rect.width)); hsv.h = x / rect.width; updatePickerUI(); } 
            
            // --- ЛОГИКА ГОЛОСОВОГО ВВОДА ---
            function initializeVoiceSearch() {
                const voiceSearchBtn = document.getElementById('voiceSearchBtn');
                const searchInput = document.getElementById('searchInput');
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

                if (!SpeechRecognition) {
                    console.warn("Web Speech API не поддерживается в этом браузере.");
                    return;
                }

                voiceSearchBtn.style.display = 'flex';
                const recognition = new SpeechRecognition();
                recognition.lang = 'ru-RU';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;

                recognition.onstart = () => {
                    voiceSearchBtn.classList.add('active');
                };

                recognition.onend = () => {
                    voiceSearchBtn.classList.remove('active');
                };

                recognition.onerror = (event) => {
                    console.error(`Ошибка распознавания: ${event.error}`);
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    searchInput.value = transcript;
                    setTimeout(() => performSearch(transcript), 100);
                };

                voiceSearchBtn.addEventListener('click', () => {
                    recognition.start();
                });
            }

            // --- ГЛАВНАЯ ФУНКЦИЯ ИНИЦИАЛИЗАЦИИ ---
            function initializeApp() {
                loadState();
                applyTheme();
                renderBookmarks();
                initializeCurrencyPicker();
                initializeCustomSelects(document.body);
                populateAllSettingsTab();
                initializeVoiceSearch();
                updateAllUIFromState();

                // --- Глобальные обработчики ---
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.settings-menu') && !e.target.closest('.settings-btn')) document.getElementById('settingsMenu')?.classList.remove('show');
                    if (!e.target.closest('.widget-settings-menu') && !e.target.closest('.widget-settings-btn')) document.getElementById('widgetSettingsMenu')?.classList.remove('show');
                    if (!e.target.closest('.custom-select-wrapper')) { document.querySelectorAll('.custom-select-wrapper.open').forEach(w => w.classList.remove('open')); }
                    if (!e.target.closest('.popup-panel, [data-control], .color-picker-panel')) { closeAllPopups(); }
                });
                settingsChannel.onmessage = (e) => {
                    if (e.data.type.includes('-update')) {
                       loadState();
                       applyTheme();
                       updateAllUIFromState();
                    }
                };

                // --- Обработчики главной страницы ---
                const mainPage = document.getElementById('main-page');
                const settingsPage = document.getElementById('settings-page');
                document.getElementById('settingsBtn')?.addEventListener('click', (e) => { e.stopPropagation(); document.getElementById('settingsMenu').classList.toggle('show'); });
                document.getElementById('openSettings')?.addEventListener('click', () => { mainPage.style.display = 'none'; settingsPage.style.display = 'flex'; document.getElementById('settingsMenu').classList.remove('show'); });
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') performSearch(e.target.value) });
                    searchInput.addEventListener('blur', (e) => { const value = e.target.value.trim(); if (value && !value.includes(' ') && !value.includes('.') && !value.startsWith('http')) e.target.value = `${value}.com`; });
                    setTimeout(() => searchInput.focus(), 1800);
                }
                document.getElementById('buttonsContainer')?.addEventListener('click', (e) => { const addBtn = e.target.closest('#addBtn'); if (addBtn) { document.getElementById('menuTitle').textContent = 'Добавить закладку'; document.getElementById('submitBtn').textContent = 'Добавить'; document.getElementById('bookmarkForm').reset(); document.getElementById('bookmarkId').value = ''; document.getElementById('autoImageOption').click(); document.getElementById('fullscreenMenu').classList.add('show'); document.getElementById('bookmarkName').focus(); return; } const siteBtn = e.target.closest('.site-btn'); const settingsWidgetBtn = e.target.closest('.widget-settings-btn'); if (siteBtn) window.location.href = siteBtn.dataset.url; if (settingsWidgetBtn) { e.stopPropagation(); activeWidgetId = settingsWidgetBtn.closest('.site-btn-container').dataset.id; const rect = settingsWidgetBtn.getBoundingClientRect(); const widgetSettingsMenu = document.getElementById('widgetSettingsMenu'); widgetSettingsMenu.style.left = `${rect.left + rect.width / 2}px`; widgetSettingsMenu.style.top = `${rect.top - 10}px`; widgetSettingsMenu.classList.toggle('show'); } });
                document.getElementById('widgetSettingsMenu')?.addEventListener('click', (e) => { const action = e.target.dataset.action; if (!action || !activeWidgetId) return; const bookmarks = getBookmarks(); const bookmarkToActOn = bookmarks.find(b => b.id == activeWidgetId); if (action === 'edit') { document.getElementById('menuTitle').textContent = 'Редактировать закладку'; document.getElementById('submitBtn').textContent = 'Сохранить'; document.getElementById('bookmarkId').value = bookmarkToActOn.id; document.getElementById('bookmarkName').value = bookmarkToActOn.name; document.getElementById('bookmarkUrl').value = bookmarkToActOn.url; if(bookmarkToActOn.image.startsWith('data:image')) document.getElementById('customImageOption').click(); else document.getElementById('autoImageOption').click(); document.getElementById('fullscreenMenu').classList.add('show'); } else if (action === 'delete') { saveBookmarks(bookmarks.filter(b => b.id != activeWidgetId)); renderBookmarks(); } document.getElementById('widgetSettingsMenu').classList.remove('show'); });
                document.getElementById('closeMenu')?.addEventListener('click', () => document.getElementById('fullscreenMenu').classList.remove('show'));
                document.getElementById('autoImageOption')?.addEventListener('click', () => { document.getElementById('autoImageOption').classList.add('selected'); document.getElementById('customImageOption').classList.remove('selected'); document.getElementById('urlInputContainer').classList.remove('hidden'); document.getElementById('fileInputContainer').classList.add('hidden'); document.getElementById('bookmarkUrl').required = true; });
                document.getElementById('customImageOption')?.addEventListener('click', () => { document.getElementById('customImageOption').classList.add('selected'); document.getElementById('autoImageOption').classList.remove('selected'); document.getElementById('urlInputContainer').classList.add('hidden'); document.getElementById('fileInputContainer').classList.remove('hidden'); document.getElementById('bookmarkUrl').required = false; });
                document.getElementById('bookmarkForm')?.addEventListener('submit', async (e) => { e.preventDefault(); const id = document.getElementById('bookmarkId').value; let name = document.getElementById('bookmarkName').value.trim(); const url = document.getElementById('bookmarkUrl').value; const imageOption = document.querySelector('input[name="imageOption"]:checked').value; const imageFile = document.getElementById('bookmarkImage').files[0]; if (!name && url) { try { name = new URL(url.startsWith('http') ? url : `https://${url}`).hostname.replace('www.', ''); } catch { name = "Без названия"; } } else if (!name) { name = "Без названия"; } let image; if (imageOption === 'custom' && imageFile) { image = await readFileAsBase64(imageFile); } else { image = getFaviconUrl(url); } let bookmarks = getBookmarks(); const newBookmarkData = { name, url, image }; if (id) { const index = bookmarks.findIndex(b => b.id == id); if (index > -1) bookmarks[index] = { ...bookmarks[index], ...newBookmarkData }; } else { bookmarks.push({ id: Date.now(), ...newBookmarkData }); } saveBookmarks(bookmarks); renderBookmarks(); document.getElementById('fullscreenMenu').classList.remove('show'); });
                const aboutBtn = document.getElementById('aboutBtn'); const aboutPopup = document.getElementById('aboutPopup'); if(aboutBtn && aboutPopup) { aboutBtn.addEventListener('mouseenter', () => { const rect = aboutBtn.getBoundingClientRect(); aboutPopup.style.top = `${rect.top}px`; aboutPopup.style.left = `${rect.left - aboutPopup.offsetWidth - 10}px`; aboutPopup.classList.add('show'); }); aboutBtn.addEventListener('mouseleave', () => { aboutPopup.classList.remove('show'); }); }

                // --- Обработчики страницы настроек ---
                document.getElementById('closeSettingsBtn')?.addEventListener('click', () => { settingsPage.style.display = 'none'; mainPage.style.display = 'flex'; });
                document.querySelector('#settings-page main')?.addEventListener('change', e => { const target = e.target.closest('[data-group][data-key]'); if (target) { const { group, key } = target.dataset; const value = target.type === 'checkbox' ? target.checked : target.value; appState[group][key] = value; saveState(group); applyTheme(); updateAllUIFromState(); } });
                document.querySelector('#settings-page')?.addEventListener('click', e => {
                    const control = e.target.closest('[data-control]');
                    if (control) {
                        e.stopPropagation();
                        const controlType = control.dataset.control;
                        const settingItem = control.closest('.setting-item');
                        if (!settingItem) return;
                        switch (controlType) {
                            case 'theme-picker': { const panel = settingItem.querySelector('.theme-picker-panel'); if (panel) { togglePopup(control, panel); } break; }
                            case 'currency-picker': { const panel = settingItem.querySelector('.currency-picker-panel'); if (panel) { togglePopup(control, panel); } break; }
                            case 'color-picker': { activeColorKey = control.dataset.colorKey; const colorPickerPanel = document.getElementById('colorPicker'); if (colorPickerPanel) { togglePopup(control, colorPickerPanel); if (colorPickerPanel.classList.contains('show')) { setTimeout(() => { drawHueCanvas(); hsv = rgbToHsv(appState.colors[activeColorKey].r, appState.colors[activeColorKey].g, appState.colors[activeColorKey].b); updatePickerUI(); }, 0); } } break; }
                        }
                    }
                    const themeItem = e.target.closest('.popup-menu-item[data-theme-value]');
                    if (themeItem) {
                        const settingItem = themeItem.closest('.setting-item');
                        if (!settingItem) return;
                        const themeValue = themeItem.dataset.themeValue;
                        if (themeValue === 'custom') {
                            const customPanel = settingItem.querySelector('.custom-theme-picker-panel');
                            if (customPanel) togglePopup(themeItem, customPanel);
                            return;
                        }
                        if (themeValue) {
                            appState.settings.theme = themeValue;
                            saveState('settings');
                            applyTheme();
                            updateAllUIFromState();
                            closeAllPopups();
                        }
                    }
                });
                document.querySelector('.sidebar-menu')?.addEventListener('click', e => { const link = e.target.closest('.sidebar-link'); if (link) { e.preventDefault(); document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active')); link.classList.add('active'); document.querySelectorAll('.settings-section').forEach(section => { section.classList.toggle('active', section.id === link.dataset.target); }); } });
                
                // --- Обработчики Color Picker ---
                if(colorPicker) {
                    svCanvas.addEventListener('mousedown', (e) => { isDraggingSV = true; handleSvChange(e); });
                    hueCanvas.addEventListener('mousedown', (e) => { isDraggingHue = true; handleHueChange(e); });
                    document.addEventListener('mousemove', (e) => { if (isDraggingSV) handleSvChange(e); if (isDraggingHue) handleHueChange(e); });
                    document.addEventListener('mouseup', () => { if (isDraggingSV || isDraggingHue) saveAndApplyPickedColor(); isDraggingSV = false; isDraggingHue = false; });
                    hexInput.addEventListener('change', () => { const rgb = hexToRgb(hexInput.value); if (rgb) { appState.colors[activeColorKey] = rgb; hsv = rgbToHsv(rgb.r, rgb.g, rgb.b); updatePickerUI(); saveAndApplyPickedColor(); } });
                }
            }

            initializeApp();
        });
    </script>
</body>
</html>